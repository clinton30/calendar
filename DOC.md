# 基于Qt的桌面日历程序设计及实现

为了介绍具体的设计以及实现过程，首先简要介绍一下功能，接着，将根据功能点，逐项介绍各个功能具体的设计及实现。

## 功能概要

1. 正确实现按月显示的公历日历。可以参考Qt中`QCalendarWidget`的实现或者直接使用它。
2. 可以编辑日历的某一天：点击某一天可以设置这一天的事件，颜色等属性。
   交互样式可以参考DesktopCal或OneCalendar。
3. 可以添加、编辑、删除某一天的事件序列。例如，某个事件在设置时，可以
   按天、按周、按月或者按其他规律重复发生，要求用户可以直接一次性添加
   一系列事件。要求用户在删除事件时可以选择删除时间序列中的单独一个事
   件或直接删除整个序列的所有事件。
4. 实现本地文件与桌面日历程序的拖拽交互：（1）把本地文件拖入桌面日历程
   序的某一天，在当天的格子内显示文件名称，并且把文件存入桌面日历程序
   的某个文件夹下。（2）可以通过日历程序把存放在某天的文件通过拖拽文件
   名称存放到本地文件夹内进行保存。（3）设置一个按钮用来打开和关闭桌面
   日历程序与本地文件的拖拽交互。
5. 支持使用配置文件（如XML 文件）进行数据同步：支持用户导出所有事件和
   对应颜色数据到配置文件（文本或二进制格式均可）中，并支持程序导入该
   配置文件。
6. 可以对日历进行整体拖拽和固定。参照DesktopCal程序，设置一个按钮可以
   移动和固定整个界面。固定界面之后日历不再响应鼠标事件，并且在透明区
   域让鼠标事件仍然传递到桌面。
7. 国际化：至少支持中文、英文两种模式。
8. 用户数据以及通过拖拽方式保存到日历程序的文件，采用内存数据库（In-Memory
   Database）存储，如采用SQLite 数据库，或其他优秀的内存数据库（如Derby）。
9. 支持对事件和文件名称的全文检索。

## 显示日历

事实上，样例程序中使用的`QCalendarWidget`完全能够满足这项要求。然而，经过研究，使用QCalendarWidget的话，在处理“文件拖拽”的时候会遇到一定的麻烦。

所以，我从头实现了日历的显示。

首先，我实现了`DateItem`。它继承自`QWidget`，用来保存及显示某一天的日期，显示待办事项以及用户存储的文件列表。

我主要重写了`QWidget`的`paintEvent`，在其中使用`QPainter`向屏幕绘制上述内容。其中，待办事项以及用户存储的文件列表是一个HTML字符串，由其他模块根据数据生成，`DateItem`直接将此HTML字符串渲染。

接着，一个`QGridLayout`存放了一些按钮用来控制某些功能的行为，以及一些`QLabel`来显示星期几、周号等简单的文本信息，还有6行（一行为一周，一个月最多可能分别占上6周）x 7列（一周七天）共42个`DateItem`真正用于显示和日期相关的信息。

要正确显示日历，就应当知道每一个格子（Grid，也就是`DateItem`）对应的日期。算法十分简单：对于任意给定的月份（包括年和月的信息），首先使用`QDate`内置函数计算出它的第一天是星期几，然后即可计算出当前月份的按月显示的日历的首行首列对应的日期。据此，就可以推算并正确显示出每一个格子的日期了。

## 编辑某一天、事件序列的CRUD

我将某一天单独的事件以及有规律（每月一次，每周一次等）发生的事件合并存储，使用统一的结构来存储。主要分为两个部分，规则以及待办事项。待办事项包括文本和颜色。文本就是一串字符串，保存用户的输入；颜色就是该待办事项文字的背景颜色。规则的颜色指的是规则对应待办事项的颜色。

当一个日期能够匹配一条规则，那么这条规则对应的待办事项就属于这一天的待办事项；当一个日期完全（精确地）匹配一条规则，那么这条规则对应的待办事项就属于这一天单独的事件，这条规则的颜色控制着这一天的颜色。如果一个日期能够完全匹配多个颜色不同的规则，那么该日期的颜色为数据库中最新插入的一条（能完全匹配该日期的）规则的颜色。

我这里使用的规则，类似于`crontab`规则的简化版。`crontab`规则在这里就不做说明了，我的简化版包括四个数字和一个字符串，分别匹配年、月、日、星期几以及排除某些日期。

// TODO

## 拖拽文件处理

### 拖入存储

### 拖出读取

##  用户数据导入导出

## 拖动窗体

## 对鼠标事件的透明

## 国际化

## 使用数据库存储各类数据